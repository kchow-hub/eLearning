<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>2I ä¸­æ–‡å¤è©©æœ—è®€ï½œé¡Œè¥¿æ—å£</title>
<style>
  :root{
    --bg:#fffafc;
    --card:#ffffff;
    --line:#e6ddff;
    --text:#242424;
    --primary:#7c4dff;
    --accent:#ffca28;
    --ok:#2e7d32;
    --soft:#f3e5f5;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
       font-family:"PingFang TC","Noto Sans TC","Microsoft JhengHei",system-ui,ui-rounded,Segoe UI,Arial,sans-serif;}
  .wrap{max-width:960px;margin:0 auto;padding:16px 16px 96px;}
  header{
    background: linear-gradient(135deg,#b39ddb 0%,#e1bee7 100%);
    border-radius:16px; padding:18px; color:#1f1b2d; position:relative; overflow:hidden;
  }
  header h1{margin:0;font-size:clamp(20px,4.8vw,30px);font-weight:800}
  header .sub{margin-top:4px;opacity:.9}
  .badge{
    position:absolute; right:-10px; top:-10px; background:#fff; color:#7c4dff;
    font-weight:800; padding:8px 12px; border-radius:14px; transform:rotate(12deg);
    box-shadow:0 6px 20px rgba(0,0,0,.12);
  }
  .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:12px 0}
  .btn{
    border:0; background:var(--primary); color:#fff; padding:10px 14px; border-radius:12px; font-weight:700;
    cursor:pointer; box-shadow:0 4px 12px rgba(124,77,255,.25); display:inline-flex; gap:8px; align-items:center; font-size:16px;
  }
  .btn.secondary{background:#fff;color:#5e35b1;border:2px solid var(--line)}
  .btn.ghost{background:transparent;color:#5e35b1;border:2px dashed var(--line)}
  .btn.small{font-size:14px;padding:8px 12px;border-radius:10px}
  .btn:active{transform:translateY(1px)}
  select.voice{
    appearance:auto; background:#fff;border:2px solid var(--line);border-radius:10px;padding:8px;font-weight:700;color:#5e35b1;
    max-width:320px;
  }
  .panel{background:var(--card);border:2px solid var(--line);border-radius:16px;padding:14px}
  .title-author{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center}
  .chip{background:#ffecb3;border:2px solid #ffe082;border-radius:999px;padding:6px 10px;font-weight:700;color:#6d4c41}
  .poem{margin-top:8px;display:flex;flex-direction:column;gap:14px}
  .line{background:var(--soft);border:2px solid var(--line);border-radius:16px;padding:10px}
  .line-head{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
  .chars{display:flex;flex-wrap:wrap;gap:8px}
  .char{
    background:#fff;border:2px solid var(--line);border-radius:14px;min-width:48px;min-height:56px;
    display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;cursor:pointer;
    box-shadow:0 2px 8px rgba(0,0,0,.06);transition:.15s;font-size:26px;line-height:1.1;
  }
  .char:active{transform:scale(.98)}
  .char.punct{background:#fafafa;border-style:dashed}
  .char.done{border-color:#c5e1a5;background:#f1f8e9}
  ruby{ruby-position:over;font-size:.85em}
  rt{font-size:.55em;color:#6a1b9a}
  .progress{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .bar{height:10px;background:#eee;border-radius:999px;overflow:hidden;width:180px;border:2px solid var(--line)}
  .bar i{display:block;height:100%;width:0;background:linear-gradient(90deg,#81c784,#ffd54f,#ba68c8)}
  .hint{font-size:14px;color:#5e35b1}
  .note{font-size:13px;color:#555}
  footer{
    position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:2px solid var(--line);padding:8px 12px;
    display:flex;justify-content:space-between;gap:8px;align-items:center;z-index:9;flex-wrap:wrap
  }
  .diag{font-size:12px;color:#666}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;place-items:center;z-index:99}
  .overlay.show{display:grid}
  .modal{background:#fff;border-radius:18px;padding:18px;max-width:460px;width:92%;text-align:center;border:3px solid var(--line);position:relative;overflow:hidden}
  .medal{font-size:52px}
  canvas.confetti{position:absolute;inset:0;pointer-events:none}
  @media (max-width:520px){
    .char{min-width:42px;min-height:52px;font-size:24px}
    .bar{width:140px}
    select.voice{max-width:100%}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header role="banner" aria-label="2I ä¸­æ–‡å¤è©©æœ—è®€">
      <div class="badge">â­ 2I</div>
      <h1>2I ä¸­æ–‡å¤è©©æœ—è®€</h1>
      <div class="sub">è¶£å‘³é»è®€ï½œæ™®é€šè©±æœ—è®€ï½œæ‹¼éŸ³è¼”åŠ©</div>
    </header>

    <div class="toolbar" aria-label="å·¥å…·åˆ—">
      <button class="btn" id="btnReadAll">â–¶ï¸ å…¨è©©æœ—è®€</button>
      <button class="btn secondary" id="btnReadTitle">ğŸ“˜ æ¨™é¡Œï¼‹ä½œè€…</button>
      <button class="btn ghost" id="btnTogglePinyin">ğŸ”¤ é¡¯ç¤º/éš±è— æ‹¼éŸ³</button>
      <button class="btn ghost" id="btnBgm">ğŸµ èƒŒæ™¯éŸ³æ¨‚ï¼šé—œ</button>
      <button class="btn small" id="btnReset">ğŸ” å†ç©ä¸€æ¬¡</button>
      <select id="voiceSel" class="voice" title="èªéŸ³ä¾†æºï¼ˆé¸æ“‡æ™®é€šè©±/åœ‹èªï¼‰"></select>
      <button class="btn small secondary" id="btnReloadVoices">é‡è¼‰èªéŸ³</button>
      <button class="btn small secondary" id="btnTestVoice">æ¸¬è©¦èªéŸ³</button>
    </div>

    <section class="panel">
      <div class="title-author">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <span class="chip">è©©é¡Œ</span>
          <div style="font-weight:800;font-size:18px">ã€Šé¡Œè¥¿æ—å£ã€‹â€” è˜‡è»¾</div>
        </div>
        <div class="progress">
          <div class="bar" aria-label="å®Œæˆåº¦"><i id="barFill"></i></div>
          <span class="hint" id="progressText">å®Œæˆåº¦ 0%</span>
        </div>
      </div>

      <div class="poem" id="poem"></div>

      <p class="note">
        æç¤ºï¼šé»æŒ‰æ¯å€‹å­—å¯è½<strong>æ™®é€šè©±</strong>è®€éŸ³ï¼›ä¹Ÿå¯æŒ‰ã€Œæ•´å¥æœ—è®€ã€æˆ–ã€Œå…¨è©©æœ—è®€ã€ã€‚<br>
        å¦‚æœä»è½åˆ°<strong>ç²µèª</strong>ï¼Œè«‹åœ¨ä¸Šæ–¹ã€ŒèªéŸ³ä¾†æºã€é¸æ“‡ <em>Mandarin / æ™®é€šè©± / zhâ€‘CN / zhâ€‘TW</em> çš„è²éŸ³ï¼Œæˆ–æŒ‰ã€Œé‡è¼‰èªéŸ³ã€ã€‚
      </p>
      <details class="diag"><summary>é¡¯ç¤ºè¨ºæ–·ï¼ˆé‡åˆ°èªéŸ³å•é¡Œæ™‚ï¼‰</summary>
        <div id="diag"></div>
      </details>
    </section>
  </div>

  <!-- å®Œæˆçå‹µ -->
  <div class="overlay" id="reward">
    <div class="modal">
      <canvas class="confetti" id="confetti"></canvas>
      <div class="medal">ğŸ…</div>
      <h2>å¤ªæ£’äº†ï¼å®ŒæˆæŒ‘æˆ° ğŸ‰</h2>
      <p>ä½ ç²å¾— <strong>å°å°æœ—è®€é”äºº</strong> çç« ï¼</p>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:10px">
        <button class="btn ok" id="btnRewardOk">å¥½ï¼</button>
        <button class="btn secondary" id="btnRewardAgain">å†ç©ä¸€æ¬¡</button>
      </div>
    </div>
  </div>

  <footer>
    <span>ğŸ‘¶ å°æç¤ºï¼šé•·æŒ‰å­—å¡ä¹Ÿå¯ä»¥è½å–”ï¼</span>
    <span id="supportNote" class="diag"></span>
  </footer>

<script>
/* ===========================
 * å…§å®¹ï¼šé¡Œè¥¿æ—å£ï¼ˆè˜‡è»¾ï¼‰+ æ‹¼éŸ³
 * =========================== */
const TITLE = "é¡Œè¥¿æ—å£";
const AUTHOR = "è˜‡è»¾";
const LINES = [
  [
    {c:"æ©«",p:"hÃ©ng"},{c:"çœ‹",p:"kÃ n"},{c:"æˆ",p:"chÃ©ng"},{c:"å¶º",p:"lÇng"},
    {c:"å´",p:"cÃ¨"},{c:"æˆ",p:"chÃ©ng"},{c:"å³°",p:"fÄ“ng"},{c:"ï¼Œ",p:""}
  ],
  [
    {c:"é ",p:"yuÇn"},{c:"è¿‘",p:"jÃ¬n"},{c:"é«˜",p:"gÄo"},{c:"ä½",p:"dÄ«"},
    {c:"å„",p:"gÃ¨"},{c:"ä¸",p:"bÃ¹"},{c:"åŒ",p:"tÃ³ng"},{c:"ã€‚",p:""}
  ],
  [
    {c:"ä¸",p:"bÃ¹"},{c:"è­˜",p:"shÃ­"},{c:"å»¬",p:"lÃº"},{c:"å±±",p:"shÄn"},
    {c:"çœŸ",p:"zhÄ“n"},{c:"é¢",p:"miÃ n"},{c:"ç›®",p:"mÃ¹"},{c:"ï¼Œ",p:""}
  ],
  [
    {c:"åª",p:"zhÇ"},{c:"ç·£",p:"yuÃ¡n"},{c:"èº«",p:"shÄ“n"},{c:"åœ¨",p:"zÃ i"},
    {c:"æ­¤",p:"cÇ"},{c:"å±±",p:"shÄn"},{c:"ä¸­",p:"zhÅng"}
  ]
];

/* ===========================
 * åŸºæœ¬ç‹€æ…‹èˆ‡å…ƒç´ 
 * =========================== */
const poemEl = document.getElementById('poem');
const barFill = document.getElementById('barFill');
const progressText = document.getElementById('progressText');
const diagEl = document.getElementById('diag');

let totalChars = 0; // ä¸å«æ¨™é»
let learnedSet = new Set();
let pinyinVisible = true;

/* ===========================
 * UI æ§‹å»º
 * =========================== */
function makeRuby(char, py, punct=false){
  if (punct) return char;
  return `<ruby><rb>${char}</rb><rt>${py}</rt></ruby>`;
}

function buildPoem(){
  poemEl.innerHTML = "";
  learnedSet.clear();
  totalChars = 0;
  LINES.forEach((line, idx)=>{
    const box = document.createElement('div');
    box.className = "line";

    const head = document.createElement('div');
    head.className = "line-head";
    const chip = document.createElement('div');
    chip.className = "chip";
    chip.textContent = `ç¬¬ ${idx+1} å¥`;
    const btn = document.createElement('button');
    btn.className = "btn small";
    btn.textContent = "â–¶ï¸ æ•´å¥æœ—è®€";
    btn.addEventListener('click', ()=>{
      sfxClick();
      ensureAudio();
      speakSentence(line);
    });
    head.append(chip, btn);

    const row = document.createElement('div'); row.className = "chars";
    line.forEach(item=>{
      const isPunct = /[ï¼Œã€‚ï¼ï¼Ÿã€ï¼›ï¼š]/.test(item.c);
      const el = document.createElement('button');
      el.className = "char" + (isPunct?" punct":"");
      el.innerHTML = makeRuby(item.c,item.p,isPunct);
      if (!isPunct) totalChars++;

      const mark = ()=>{
        if (isPunct) return;
        if (!el.classList.contains('done')){
          el.classList.add('done');
          learnedSet.add(el);
          updateProgress();
          sfxGood();
        }
      };

      const onTap = ()=>{
        ensureAudio();
        speakChar(item.c);
        mark();
      };
      el.addEventListener('click', onTap);
      el.addEventListener('touchstart', onTap, {passive:true});

      row.appendChild(el);
    });

    box.append(head, row);
    poemEl.appendChild(box);
  });
  if (!pinyinVisible) togglePinyin(false);
  updateProgress();
}

function updateProgress(){
  const done = learnedSet.size;
  const percent = Math.round(done / totalChars * 100);
  barFill.style.width = percent + "%";
  progressText.textContent = `å®Œæˆåº¦ ${percent}%`;
  if (percent === 100) showReward();
}

function togglePinyin(force){
  if (typeof force === "boolean") pinyinVisible = force; else pinyinVisible = !pinyinVisible;
  document.querySelectorAll('rt').forEach(rt=>{
    rt.style.display = pinyinVisible ? "" : "none";
  });
}

/* ===========================
 * èªéŸ³ï¼ˆå¼·åˆ¶æ™®é€šè©±å„ªå…ˆï¼‰
 * =========================== */
const supportNote = document.getElementById('supportNote');
const voiceSel = document.getElementById('voiceSel');
const synth = 'speechSynthesis' in window ? window.speechSynthesis : null;
let allVoices = [];
let currentVoice = null;

function isCantonese(v){
  const n=(v.name||"").toLowerCase();
  const l=(v.lang||"").toLowerCase();
  return /yue|cantonese|zh\-hk|zh_hk|hong\s*kong|ç²µ|ç²¤/.test(n+l);
}
function isMandarin(v){
  const n=(v.name||"").toLowerCase();
  const l=(v.lang||"").toLowerCase();
  return /(zh\-cn|zh_cn|zh\-tw|zh_tw|cmn)/.test(l) || /mandarin|æ™®é€šè¯|åœ‹èª|å›½èª/.test(n);
}
function bestMandarin(voices){
  const cand = voices.filter(v=> !isCantonese(v));
  const tiers = [
    v=> isMandarin(v) && /zh\-cn/i.test(v.lang||"") && /female|å¥³/.test((v.name||"").toLowerCase()),
    v=> isMandarin(v) && /zh\-cn/i.test(v.lang||""),
    v=> isMandarin(v) && /zh\-tw/i.test(v.lang||""),
    v=> isMandarin(v),
    v=> /zh/i.test(v.lang||"")
  ];
  for (const rule of tiers){
    const v = cand.find(rule);
    if (v) return v;
  }
  return cand[0] || voices[0] || null;
}

function populateVoiceSelect(){
  voiceSel.innerHTML = "";
  if (!allVoices.length){
    voiceSel.appendChild(new Option("ï¼ˆå°šç„¡èªéŸ³ï¼Œè«‹é»ä¸€ä¸‹é é¢æˆ–æŒ‰ã€Œé‡è¼‰èªéŸ³ã€ï¼‰",""));
    diag("å°šæœªå–å¾—èªéŸ³åˆ—è¡¨ã€‚");
    return;
  }
  const mand = allVoices.filter(v=> isMandarin(v) && !isCantonese(v));
  const others = allVoices.filter(v=> !mand.includes(v));

  const og1 = document.createElement('optgroup'); og1.label = "æ™®é€šè©±/åœ‹èªï¼ˆå»ºè­°ï¼‰";
  mand.forEach(v=>{
    og1.appendChild(new Option(`${v.name} â€” ${v.lang}`, String(allVoices.indexOf(v))));
  });
  if (mand.length) voiceSel.appendChild(og1);

  const og2 = document.createElement('optgroup'); og2.label = "å…¶ä»–èªéŸ³";
  others.forEach(v=>{
    og2.appendChild(new Option(`${v.name} â€” ${v.lang}`, String(allVoices.indexOf(v))));
  });
  voiceSel.appendChild(og2);

  const def = bestMandarin(allVoices);
  if (def){
    currentVoice = def;
    voiceSel.value = String(allVoices.indexOf(def));
  }
  diag(`å¯ç”¨èªéŸ³ï¼š${allVoices.length}ï¼›é è¨­ï¼š${def?def.name+" ("+def.lang+")":"ç„¡"}`);
}

function refreshVoices(){
  if (!synth) return;
  const vs = synth.getVoices();
  if (vs && vs.length){
    allVoices = vs;
    populateVoiceSelect();
  } else {
    // å†å˜—è©¦å¹¾æ¬¡ï¼ˆiOS å¸¸éœ€è¦æ™‚é–“ï¼‰
    setTimeout(refreshVoices, 500);
  }
}

if (synth){
  synth.onvoiceschanged = () => { allVoices = synth.getVoices(); populateVoiceSelect(); };
  // è§¸ç™¼ä¸€æ¬¡
  refreshVoices();
} else {
  supportNote.textContent = "âš ï¸ æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³æœ—è®€ï¼ˆSpeechSynthesisï¼‰ã€‚";
}

function getVoice(){
  const idx = Number(voiceSel.value);
  if (!Number.isNaN(idx) && allVoices[idx]) return allVoices[idx];
  return currentVoice || bestMandarin(allVoices);
}

function speakUtterance(text, rate=0.95){
  if (!synth || !text) return;
  const v = getVoice();
  const u = new SpeechSynthesisUtterance(text);
  if (v){ u.voice = v; u.lang = /zh\-tw/i.test(v.lang||"") ? "zh-TW" : "zh-CN"; }
  else { u.lang = "zh-CN"; }
  u.rate = rate; u.pitch = 1.0; u.volume = 1.0;
  synth.speak(u);
}

function speakSingle(text, rate=0.95){
  if (!synth) return;
  synth.cancel();
  speakUtterance(text, rate);
}

function speakQueue(arr, rate=0.95){
  if (!synth) return;
  synth.cancel();
  arr.forEach(t => speakUtterance(t, rate));
}

/* æœ—è®€ï¼šå­—ã€å¥ã€å…¨è©© */
function speakChar(ch){
  // å–®å­—è®€éŸ³
  speakSingle(ch, 0.9);
}
function speakSentence(line){
  const sentence = line.map(x=>x.c).join("");
  speakSingle(sentence, 0.95);
}
function speakAll(){
  const title = `ã€Š${TITLE}ã€‹ï¼›${AUTHOR}ã€‚`;
  const lines = LINES.map(line=> line.map(x=>x.c).join(""));
  speakQueue([title, ...lines], 0.95);
}

/* ===========================
 * èƒŒæ™¯éŸ³æ¨‚ï¼ˆè¶…æŸ”å’Œï¼é è¨­é—œï¼‰
 * =========================== */
let audioCtx = null, bgmTimer = null, bgmOn = false, bgmMaster = null;
function ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
function sfxClick(){
  ensureAudio();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = "sine"; o.frequency.value = 523.25; // C5
  g.gain.value = 0.07;
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.2);
  o.connect(g).connect(audioCtx.destination);
  o.start(); o.stop(audioCtx.currentTime+0.22);
}
function sfxGood(){
  ensureAudio();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = "sine"; o.frequency.setValueAtTime(659.25, audioCtx.currentTime); // E5
  o.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime+0.16);
  g.gain.value = 0.09;
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.28);
  o.connect(g).connect(audioCtx.destination);
  o.start(); o.stop(audioCtx.currentTime+0.3);
}
function pluck(freq, vol=1){
  ensureAudio();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  const f = audioCtx.createBiquadFilter();
  o.type = "triangle"; o.frequency.value = freq;
  f.type = "lowpass"; f.frequency.value = 1800;
  const now = audioCtx.currentTime;
  if (!bgmMaster){ bgmMaster = audioCtx.createGain(); bgmMaster.gain.value = 0.05; bgmMaster.connect(audioCtx.destination); }
  g.gain.setValueAtTime(0.0001, now);
  g.gain.exponentialRampToValueAtTime(0.07*vol, now+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, now+0.7);
  o.connect(f).connect(g).connect(bgmMaster);
  o.start(now); o.stop(now+0.72);
}
function startBgm(){
  ensureAudio();
  stopBgm();
  bgmOn = true;
  const base = 261.63; const pent = [0,2,4,7,9]; // C å¤§èª¿äº”è²
  let step = 0; const beat = 750;
  bgmTimer = setInterval(()=>{
    if (!bgmOn) return;
    const deg = pent[step % pent.length];
    const f = base * Math.pow(2, deg/12);
    pluck(f, 1);
    if (step % 4 === 0) pluck(base/2, 0.6); // æº«æŸ”ä½éŸ³
    step++;
  }, beat);
  document.getElementById('btnBgm').textContent = "ğŸµ èƒŒæ™¯éŸ³æ¨‚ï¼šé–‹";
}
function stopBgm(){
  bgmOn = false;
  if (bgmTimer){ clearInterval(bgmTimer); bgmTimer=null; }
  if (bgmMaster){ try{ bgmMaster.disconnect(); }catch(e){} bgmMaster=null; }
  document.getElementById('btnBgm').textContent = "ğŸµ èƒŒæ™¯éŸ³æ¨‚ï¼šé—œ";
}
function toggleBgm(){ bgmOn ? stopBgm() : startBgm(); }

/* ===========================
 * çå‹µï¼šå½©å¸¶
 * =========================== */
const reward = document.getElementById('reward');
const confettiCanvas = document.getElementById('confetti');
let confettiCtx, confettiPieces=[], confettiRAF=null;

function showReward(){ reward.classList.add('show'); startConfetti(); }
function hideReward(){ reward.classList.remove('show'); stopConfetti(); }
function startConfetti(){
  const c = confettiCanvas;
  c.width = c.clientWidth; c.height = c.clientHeight;
  confettiCtx = c.getContext('2d');
  confettiPieces = Array.from({length:120}).map(()=> ({
    x: Math.random()*c.width,
    y: -10 - Math.random()*c.height,
    r: 6 + Math.random()*10,
    col: ["#ff8a65","#4db6ac","#ba68c8","#ffd54f","#90caf9"][Math.floor(Math.random()*5)],
    spd: 1 + Math.random()*2,
    rot: Math.random()*Math.PI*2
  }));
  const draw = ()=>{
    confettiCtx.clearRect(0,0,c.width,c.height);
    confettiPieces.forEach(p=>{
      p.y += p.spd; p.x += Math.sin(p.y*0.02); p.rot += 0.1;
      confettiCtx.save(); confettiCtx.translate(p.x,p.y); confettiCtx.rotate(p.rot);
      confettiCtx.fillStyle = p.col; confettiCtx.fillRect(-p.r/2,-p.r/2,p.r,p.r*0.6);
      confettiCtx.restore();
      if (p.y > c.height + 20) p.y = -10;
    });
    confettiRAF = requestAnimationFrame(draw);
  };
  draw();
}
function stopConfetti(){ if (confettiRAF) cancelAnimationFrame(confettiRAF); }

/* ===========================
 * äº‹ä»¶
 * =========================== */
document.getElementById('btnReadAll').addEventListener('click', ()=>{ sfxClick(); ensureAudio(); speakAll(); });
document.getElementById('btnReadTitle').addEventListener('click', ()=>{ sfxClick(); ensureAudio(); speakSingle(`ã€Š${TITLE}ã€‹ï¼Œä½œè€…ï¼š${AUTHOR}ã€‚`, 0.98); });
document.getElementById('btnTogglePinyin').addEventListener('click', ()=>{ sfxClick(); togglePinyin(); });
document.getElementById('btnBgm').addEventListener('click', ()=>{ toggleBgm(); });
document.getElementById('btnReset').addEventListener('click', ()=>{
  sfxClick();
  document.querySelectorAll('.char.done').forEach(el=> el.classList.remove('done'));
  learnedSet.clear(); updateProgress();
});
document.getElementById('btnReloadVoices').addEventListener('click', ()=>{ sfxClick(); refreshVoices(); });
document.getElementById('btnTestVoice').addEventListener('click', ()=>{
  sfxClick(); ensureAudio();
  speakSingle("ä½ å¥½ï¼é€™æ˜¯æ™®é€šè©±æ¸¬è©¦ã€‚", 1.0);
});
voiceSel.addEventListener('change', ()=>{
  const idx = Number(voiceSel.value);
  if (allVoices[idx]) currentVoice = allVoices[idx];
  diag(`å·²é¸èªéŸ³ï¼š${currentVoice?currentVoice.name+" ("+currentVoice.lang+")":"ç„¡"}`);
});
document.getElementById('btnRewardOk').addEventListener('click', ()=>{ sfxClick(); hideReward(); });
document.getElementById('btnRewardAgain').addEventListener('click', ()=>{ sfxClick(); hideReward();
  document.getElementById('btnReset').click();
});

/* åœ¨ç¬¬ä¸€ä¸‹äº’å‹•æ™‚è§£é–éŸ³è¨Šï¼ˆè¡Œå‹•è£ç½®éœ€è¦ï¼‰ */
document.addEventListener('pointerdown', ()=>{ try{ ensureAudio(); }catch(e){} }, {once:true});

/* ===========================
 * å°å·¥å…·
 * =========================== */
function diag(msg){
  const t = new Date().toLocaleTimeString();
  diagEl.insertAdjacentHTML('beforeend', `<div>[${t}] ${msg}</div>`);
}

/* ===========================
 * å•Ÿå‹•
 * =========================== */
buildPoem();
togglePinyin(true); // åˆå§‹é¡¯ç¤ºæ‹¼éŸ³
diag('åˆå§‹åŒ–å®Œæˆã€‚è‹¥èªéŸ³ä»ç„¡æ³•ä½¿ç”¨ï¼Œè«‹é»æ“Šã€Œé‡è¼‰èªéŸ³ã€æˆ–ä»»æ„è™•ä»¥å…è¨±éŸ³è¨Šã€‚');

</script>
</body>
</html>
