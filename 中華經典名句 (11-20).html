<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>中一名句溫習 - 中文輸入優化版</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --error: #e74c3c; --bg: #f8f9fa; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, "PingFang HK", sans-serif; background-color: var(--bg); margin: 0; display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        .game-card { width: 100%; max-width: 650px; min-height: 500px; background: white; padding: 30px; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.08); display: flex; flex-direction: column; }
        .progress-bar { width: 100%; height: 6px; background: #eee; border-radius: 3px; margin-bottom: 20px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }
        h2 { color: var(--primary); font-size: 1.1em; text-align: center; margin: 0 0 20px 0; opacity: 0.7; }
        .question-content { flex-grow: 1; display: flex; flex-wrap: wrap; justify-content: center; align-content: center; font-size: 1.8em; line-height: 2; color: #2c3e50; text-align: center; gap: 8px; margin: 20px 0; }
        input { border: 2px solid #dfe6e9; width: 50px; height: 50px; text-align: center; font-size: 1em; border-radius: 12px; outline: none; background: #fff; transition: 0.2s; }
        input:focus { border-color: var(--accent); background: #f0f7ff; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2); }
        input.correct { border-color: var(--success); background: #eafaf1; color: var(--success); }
        input.wrong { border-color: var(--error); background: #fdeded; color: var(--error); }
        .feedback { font-weight: bold; font-size: 1.1em; min-height: 1.5em; text-align: center; margin: 10px 0; }
        button { width: 100%; padding: 18px; font-size: 1.1em; cursor: pointer; border: none; border-radius: 16px; font-weight: bold; transition: 0.2s; }
        .check-btn { background: var(--primary); color: white; }
        .next-btn { background: var(--success); color: white; display: none; }
    </style>
</head>
<body>

<div class="game-card">
    <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
    <h2>中華經典名句 (11-20)</h2>
    <div class="question-content" id="question-box"></div>
    <div class="feedback" id="feedback"></div>
    <div class="footer-btns">
        <button class="check-btn" id="check-btn" onclick="checkCurrentAnswer()">檢查答案</button>
        <button class="next-btn" id="next-btn" onclick="nextQuestion()">下一題</button>
    </div>
</div>

<script>
    const sentences = [
        "採菊東籬下，悠然見南山。", // [cite: 36, 38]
        "明月松間照，清泉石上流。竹喧歸浣女，蓮動下漁舟。", // [cite: 40, 41]
        "山不在高，有仙則名。水不在深，有龍則靈。斯是陋室，惟吾德馨。", // [cite: 43]
        "悠悠乎與顥氣俱，而莫得其涯；洋洋乎與造物者遊，而不知其所窮。", // [cite: 44, 45]
        "父母之年，不可不知也。一則以喜，一則以懼。", // [cite: 50]
        "誰言寸草心，報得三春暉。", // [cite: 52]
        "思爾為雛日，高飛背母時。當時父母念，今日爾應知！", // [cite: 53]
        "百鳥豈無母？爾獨哀怨深。應是母慈重，使爾悲不任。", // [cite: 55]
        "海內存知己，天涯若比鄰。", // [cite: 59]
        "每逢佳節倍思親。" // [cite: 62]
    ];

    let currentIndex = 0;
    let score = 0;
    let isComposing = false; // 追蹤是否正在輸入中文預選字

    function loadQuestion() {
        const box = document.getElementById('question-box');
        const text = sentences[currentIndex];
        document.getElementById('progress-fill').style.width = `${((currentIndex + 1) / 10) * 100}%`;
        document.getElementById('feedback').innerText = "";
        box.innerHTML = "";
        
        let chars = text.split("");
        let indices = chars.map((c, i) => /[，。？！；、]/.test(c) ? -1 : i).filter(i => i !== -1);
        let numToHide = Math.min(3, Math.max(1, Math.floor(indices.length * 0.3)));
        let hiddenIndices = indices.sort(() => 0.5 - Math.random()).slice(0, numToHide);

        chars.forEach((char, i) => {
            if (hiddenIndices.includes(i)) {
                const input = document.createElement('input');
                input.type = "text";
                input.maxLength = 1;
                input.dataset.ans = char;

                // 核心修復：中文輸入法監測 
                input.addEventListener('compositionstart', () => { isComposing = true; });
                input.addEventListener('compositionend', (e) => {
                    isComposing = false;
                    // 當選字結束，手動觸發檢查並跳轉 
                    handleJump(e.target);
                });
                input.addEventListener('input', (e) => {
                    if (!isComposing) handleJump(e.target);
                });

                box.appendChild(input);
            } else {
                const span = document.createElement('span');
                span.innerText = char;
                box.appendChild(span);
            }
        });
        document.getElementById('check-btn').style.display = "block";
        document.getElementById('next-btn').style.display = "none";
    }

    function handleJump(currentInput) {
        if (currentInput.value.length >= 1) {
            const allInputs = Array.from(document.querySelectorAll('#question-box input'));
            const nextIdx = allInputs.indexOf(currentInput) + 1;
            if (allInputs[nextIdx]) allInputs[nextIdx].focus();
        }
    }

    function checkCurrentAnswer() {
        const inputs = document.querySelectorAll('#question-box input');
        let isCorrect = true;
        inputs.forEach(input => {
            if (input.value === input.dataset.ans) { input.classList.add('correct'); } 
            else { input.classList.add('wrong'); isCorrect = false; }
            input.disabled = true;
        });
        const feedback = document.getElementById('feedback');
        if (isCorrect) { feedback.innerText = "正確！✨"; feedback.style.color = "var(--success)"; score++; } 
        else { feedback.innerText = `答案：${Array.from(inputs).map(i=>i.dataset.ans).join(',')}`; feedback.style.color = "var(--error)"; }
        document.getElementById('check-btn').style.display = "none";
        document.getElementById('next-btn').style.display = "block";
    }

    function nextQuestion() {
        if (currentIndex < 9) { currentIndex++; loadQuestion(); } 
        else { 
            document.getElementById('question-box').innerHTML = `總分：${score} / 10`;
            document.getElementById('next-btn').style.display = "none";
        }
    }

    document.addEventListener('DOMContentLoaded', loadQuestion);
</script>
</body>
</html>